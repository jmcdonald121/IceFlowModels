      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION H(200),U(200),DIS(200),UNEW(200),DISNEW(200),
     1CHGTHK(200),OLDH(200),D(200)
      DATA BDOT/9.6D-09/,A/5.2D-25/,TB/0.1D06/,DX/1.0D05/,XN/3.0D0/,
     1DT/3.1536D07/,RHO/1.D03/,G/9.8/,DL/1.0D06/,SECYR/3.1536D07/,
     2B/3.171D-08/
CCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCC
C ZERO ALL VARIABLES C
CCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCC
      DT=DT/4.0D0
      ITEST=0
      X=0.0D0      
      TOL=2.0D0
      LIM=0
      SAVE=0.0D0
      CHGMAX=0.0D0
      U(1)=0.0D0
      DO 9 I=1,200
      CHGTHK(I)=0.0D0
      U(I)=0.0D0
      H(I)=0.0D0
      DIS(I)=0.0D0
      UNEW(I)=0.0D0
      DISNEW(I)=0.0D0
      OLDH(I)=0.0D0
      D(I)=0.0D0
9     CONTINUE
CCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCC
C SET INITIAL CONDITIONS C
CCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCC
C SET UP INITIAL PROFILE
      DO 10 I=1,11
      H(I)=DSQRT(2.0D0*TB/(RHO*G)*(DL+2.0D0*DX/10.0D0-X))
      X=X+DX
10    CONTINUE
      BOTTOM=H(11)
C SET UP INITIAL VELOCITIES
      DO 11 I=1,11
      U(I+1)=0.0D0
11    CONTINUE
C CONVERT VELOCITIES FROM M/S TO M/A
C---NOTE: THIS IS FOR PRINTING OUT THE INITIAL CONDITIONS------------C
      DO 12 I=1,11
      UNEW(I)=U(I)*SECYR
      DISNEW(I)=H(I)*U(I)*(1.0D0)*SECYR
12    CONTINUE
CCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCC
C PERFORM ITERATION      C
CCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCC
C---------ITERATION STATEMENT----------------------------------------C
50    IF(TOL.LE.1.0D-03.OR.LIM.GE.300000) GOTO 100
      TOL=0.0D0
      LIM=LIM+1
C---------COMPUTE VELOCITIES-----------------------------------------C
      DO 20 I=1,11
      IF(I.EQ.1) THEN
      U(1)=0.0D0
      ELSEIF(I.EQ.11) THEN
      U(I)=2.0D0*A*((-RHO*G*(H(I-2)-4.0D0*H(I-1)+3.0D0*H(I))/
     1(2.0D0*DX))**XN)*(H(11)**(XN+1.0D0))/(XN+2.0D0)
      ELSE
      U(I)=2.0D0*A*((-RHO*G*(H(I+1)-H(I-1))/(2.0D0*DX))**XN)*
     1(H(I)**(XN+1.0D0))/(XN+2.0D0)
      ENDIF
      UNEW(I)=U(I)*SECYR
      DISNEW(I)=U(I)*H(I)*(1.0D0)*SECYR
20    CONTINUE
C---------COMPUTE DIFFUSIVITY----------------------------------------C
      DO 71 I=1,11
      IF(I.EQ.1) THEN
      D(1)=0.0D0
      ELSEIF(I.EQ.11) THEN
      D(11)=(2.0D0*A*(RHO*G)**(XN)*(H(I)**(XN+2.0D0))*(DABS(H(I-2)
     1-4.0D0*H(I-1)+3.0D0*H(I))/(2.0D0*DX))**(XN-1.0D0))/(XN+2.0D0)
      ELSE
      D(I)=(2.0D0*A*(RHO*G)**(XN)*(H(I)**(XN+2.0D0))*(DABS(H(I+1)
     1-H(I-1))/(2.0D0*DX))**(XN-1.0D0))/(XN+2.0D0)
      ENDIF
71    CONTINUE
C---------COMPUTE THICKNESSES----------------------------------------C
      DO 13 I=1,11
      OLDH(I)=H(I)
      SAVE=H(I)
      IF(I.EQ.1) THEN
      H(1)=((D(I+1)+D(I))*(H(I+1)-H(I))/(DX**2)+BDOT)*DT+H(1)
      ELSEIF(I.EQ.11) THEN
      H(11)=BOTTOM
      ELSE
      H(I)=(((D(I+1)+D(I))*(H(I+1)-H(I))-(D(I)+D(I-1))*(H(I)
     1-OLDH(I-1)))/(2.0D0*(DX**2))+BDOT)*DT+H(I)
      ENDIF
      CHGTHK(I)=H(I)-SAVE
      CHGMAX=DABS(H(I)-SAVE)
      IF(TOL.LT.CHGMAX) TOL=CHGMAX     
13    CONTINUE							    
C---------TEST SECTION-----------------------------------------------C
      DO 21 I=1,11
      IF(UNEW(I).LT.0.0D0.OR.UNEW(I).GT.2.0D03) THEN
      ITEST=1
      GOTO 100
      ELSEIF(I.NE.11.AND.(H(I)-H(I+1)).LT.0.0D0) THEN
      ITEST=2
      GOTO 100
      ELSE
      CONTINUE
      ENDIF
21    CONTINUE
      WRITE(0,902) LIM
      GOTO 50
100   CONTINUE
CCCCCCCCCCCCCCCCCCCCCCCCCC
C WRITE THE OUTPUT       C
CCCCCCCCCCCCCCCCCCCCCCCCCC
C CONVERT VELOCITIES AND DISCHARGE TO M/S 
C AND M**3/S TO M/A AND M**3/A
C AND WRITE THE OUTPUT
      OPEN(2,FILE='V2SIMUL.DAT',STATUS='NEW') 
      DO 14 I=1,11
      WRITE(0,901) I,H(I),UNEW(I),DISNEW(I),CHGTHK(I)
      WRITE(2,901) I,H(I),UNEW(I),DISNEW(I),CHGTHK(I)
901   FORMAT(' ','I=',I3,3X,'H=',D15.7,5X,'U=',D15.7,5X,
     1'DISCHARGE=',D15.7,5X,'DELTHK=',D15.7)
      WRITE(0,903) D(I)
      WRITE(2,903) D(I)
903   FORMAT(' ',5X,'D=',D15.7)
14    CONTINUE
      WRITE(0,902) LIM
      WRITE(2,902) LIM
902   FORMAT(' ','THE NUMBER OF ITERATIONS =',I8)
      WRITE(0,904) ITEST
      WRITE(2,904) ITEST
904   FORMAT(' ','ITEST=',I3)
      STOP
      END

